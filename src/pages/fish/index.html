<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pesca Retro ‚Äì Prototipo</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #020617;
      font-family: system-ui, Segoe UI, Roboto, Arial;
      color: #e0e6ef;
    }
    #wrap {
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      padding: 10px;
      box-sizing: border-box;
    }
    #hud {
      display: flex;
      gap: 12px;
      align-items: center;
      font-weight: 600;
      flex-wrap: wrap;
      justify-content: center;
    }
    .pill {
      padding: 6px 10px;
      border-radius: 10px;
      background: #020617;
      box-shadow: inset 0 0 0 1px #1e293b;
      font-size: 13px;
    }

    #game-row {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }

    canvas {
      background: #020617;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.6);
      width: 100%;
      max-width: 900px;
      height: auto;
    }

    /* Panel tienda izquierda */
    #shop-panel {
      width: 230px;
      background:
        linear-gradient(135deg, rgba(148, 91, 46, 0.32), rgba(80, 48, 22, 0.45)),
        url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='40' height='40' fill='%2329241f'/%3E%3Cpath d='M0 20h40M20 0v40' stroke='%23382616' stroke-width='2'/%3E%3C/svg%3E");
      background-size: cover;
      border-radius: 14px;
      box-shadow: 0 0 0 1px #1e293b, 0 10px 20px rgba(0,0,0,.6);
      padding: 10px 12px;
      box-sizing: border-box;
      font-size: 13px;
      color: #fef9c3;
    }
    #shop-panel h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #shop-panel small {
      font-size: 11px;
      opacity: .8;
    }
    .upgrade-card {
      background: rgba(15,23,42,0.8);
      border-radius: 10px;
      padding: 8px;
      margin-bottom: 8px;
      box-shadow: 0 0 0 1px rgba(15,23,42,0.9);
      display: grid;
      grid-template-columns: 40px 1fr;
      gap: 8px;
      align-items: center;
    }
    .upgrade-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      background: radial-gradient(circle at 30% 20%, #fbbf24, #b45309);
    }
    .upgrade-info h4 {
      margin: 0;
      font-size: 13px;
    }
    .upgrade-info p {
      margin: 2px 0 4px 0;
      font-size: 11px;
      opacity: .9;
    }
    .upgrade-info .cost {
      font-size: 11px;
      opacity: .85;
      margin-bottom: 4px;
    }
    .upgrade-info button {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 4px 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: #22c55e;
      color: #022c22;
      box-shadow: 0 1px 0 rgba(0,0,0,.6);
      transition: transform 0.05s, box-shadow 0.05s, opacity 0.15s;
    }
    .upgrade-info button:active {
      transform: translateY(1px);
      box-shadow: 0 0 0 rgba(0,0,0,0.6);
    }
    .upgrade-info button:disabled {
      opacity: .45;
      cursor: not-allowed;
      background: #4b5563;
      color: #e5e7eb;
    }

    /* Panel highscores derecha */
    #highscores-panel {
      width: 190px;
      background: #020617;
      border-radius: 14px;
      box-shadow: 0 0 0 1px #1e293b, 0 10px 20px rgba(0,0,0,.6);
      padding: 10px 12px;
      box-sizing: border-box;
      font-size: 13px;
    }
    #highscores-panel h3 {
      margin: 0 0 6px 0;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #highscores-panel ol {
      margin: 0;
      padding-left: 20px;
    }
    #highscores-panel li {
      margin: 2px 0;
      font-family: "Consolas", "JetBrains Mono", monospace;
      letter-spacing: 1px;
    }

    #help {
      opacity: .9;
      font-size: 13px;
      text-align: center;
      max-width: 900px;
      line-height: 1.5;
    }

    progress {
      width: 160px;
      height: 16px;
      accent-color: #a855f7;
    }
    kbd {
      background:#020617;
      border:1px solid #334155;
      border-bottom-width:2px;
      padding:2px 6px;
      border-radius:6px;
      font-weight:700;
      font-size: 12px;
    }

    /* Controles touch */
    #touch-controls {
      display: none;
      margin-top: 8px;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
      width: 100%;
      max-width: 900px;
    }
    #touch-controls button {
      min-width: 60px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #111827;
      color: #e5e7eb;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 2px 0 #000;
      touch-action: manipulation;
    }
    #touch-controls button:active {
      transform: translateY(1px);
      box-shadow: 0 0 0 #000;
    }

    /* Panel para meter iniciales en mobile */
    #name-touch {
      display: none;
      position: fixed;
      inset: 0;
      align-items: center;
      justify-content: center;
      background: rgba(15,23,42,0.75);
      z-index: 60;
    }

    .name-touch-box {
      background: #020617;
      border-radius: 16px;
      padding: 12px 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.8);
      text-align: center;
      min-width: 260px;
    }

    .name-touch-title {
      margin: 0 0 8px;
      font-size: 14px;
    }

    .name-row {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 4px 0;
    }

    .name-row.letters span {
      font-size: 26px;
      font-weight: 700;
      letter-spacing: 10px;
    }

    #name-touch button {
      min-width: 44px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #111827;
      color: #e5e7eb;
      font-size: 16px;
      font-weight: 600;
      box-shadow: 0 2px 0 #000;
    }

    #name-ok {
      margin-top: 8px;
      width: 100%;
      background: #22c55e;
      color: #022c22;
    }

    @media (max-width: 900px) {
      #wrap {
        padding: 6px;
        gap: 6px;
      }

      #hud {
        gap: 6px;
        justify-content: center;
      }

      #game-row {
        flex-direction: column;
        align-items: center;
      }

      #shop-panel,
      #highscores-panel {
        width: 100%;
        max-width: 420px;
      }

      #help {
        font-size: 12px;
        max-width: 420px;
        padding: 0 6px;
      }

      /* üî• Controles SIEMPRE visibles abajo en cel */
      #touch-controls {
        display: flex;
        position: fixed;
        left: 50%;
        bottom: 8px;
        transform: translateX(-50%);
        max-width: 420px;
        background: rgba(15,23,42,0.9);
        padding: 6px 10px;
        border-radius: 999px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.6);
        z-index: 50;
      }

      body {
        padding-bottom: 90px; /* espacio para que no tape el juego */
      }

      /* Controles M√ÅS GRANDES en m√≥vil */
      #touch-controls button {
        min-width: 80px;
        padding: 12px 18px;
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div id="wrap">
    <div id="hud">
      <div class="pill">‚è±Ô∏è Tiempo: <span id="time">360</span>s</div>
      <div class="pill">‚ù§Ô∏è Vidas: <span id="lives">3</span></div>
      <div class="pill">üêü Puntos: <span id="score">0</span></div>
      <div class="pill">üí∞ Monedas: <span id="coins">0</span></div>
      <div class="pill" id="fightBox" style="display:none">üé£ Pelea: <progress id="fight" value="0" max="100"></progress></div>
    </div>

    <div id="game-row">
      <!-- TIENDA A LA IZQUIERDA -->
      <aside id="shop-panel">
        <h3>
          <span>üõí Tienda</span>
          <small>Haz clic para comprar</small>
        </h3>

        <div class="upgrade-card">
          <div class="upgrade-icon">üßµ</div>
          <div class="upgrade-info">
            <h4>Mejor carrete</h4>
            <p>Sube el anzuelo m√°s r√°pido en cada pulsaci√≥n.</p>
            <div class="cost">Costo: 20 monedas</div>
            <button id="btnReel">Comprar</button>
          </div>
        </div>

        <div class="upgrade-card">
          <div class="upgrade-icon" style="background:radial-gradient(circle at 30% 20%, #e5e7eb,#6b7280);">ü™¢</div>
          <div class="upgrade-info">
            <h4>L√≠nea reforzada</h4>
            <p>El pez jala menos la barra, se rompe menos.</p>
            <div class="cost">Costo: 30 monedas</div>
            <button id="btnLine">Comprar</button>
          </div>
        </div>

        <div class="upgrade-card">
          <div class="upgrade-icon" style="background:radial-gradient(circle at 30% 20%, #22c55e,#166534);">üêü</div>
          <div class="upgrade-info">
            <h4>M√°s peces grandes</h4>
            <p>Aumenta la probabilidad de peces grandes.</p>
            <div class="cost">Costo: 40 monedas</div>
            <button id="btnRare">Comprar</button>
          </div>
        </div>
      </aside>

      <!-- JUEGO EN EL CENTRO -->
      <canvas id="game" width="900" height="520"></canvas>

      <!-- TOP 5 A LA DERECHA -->
      <aside id="highscores-panel">
        <h3>
          <span>üèÜ Mejores 5</span>
          <span style="font-size:11px;opacity:.8;">(global)</span>
        </h3>
        <ol id="highscore-list">
          <li>--- ‚Äî 0</li>
          <li>--- ‚Äî 0</li>
          <li>--- ‚Äî 0</li>
          <li>--- ‚Äî 0</li>
          <li>--- ‚Äî 0</li>
        </ol>
      </aside>
    </div>

    <div id="touch-controls">
      <button id="btnLeft">‚óÄÔ∏é</button>
      <button id="btnRight">‚ñ∂Ô∏é</button>
      <button id="btnCast">üé£</button>
      <button id="btnRestart">üîÅ</button>
    </div>

    <!-- Overlay para meter iniciales en m√≥vil -->
    <div id="name-touch">
      <div class="name-touch-box">
        <p class="name-touch-title">üéÆ Escribe tus iniciales</p>

        <div class="name-row">
          <button data-slot="0" data-dir="up">‚ñ≤</button>
          <button data-slot="1" data-dir="up">‚ñ≤</button>
          <button data-slot="2" data-dir="up">‚ñ≤</button>
        </div>

        <div class="name-row letters">
          <span id="lt0">A</span>
          <span id="lt1">A</span>
          <span id="lt2">A</span>
        </div>

        <div class="name-row">
          <button data-slot="0" data-dir="down">‚ñº</button>
          <button data-slot="1" data-dir="down">‚ñº</button>
          <button data-slot="2" data-dir="down">‚ñº</button>
        </div>

        <button id="name-ok">OK</button>
      </div>
    </div>

    <div id="help">
      <p><strong>Controles</strong></p>
      <p>
        Teclado: <kbd>A</kbd>/<kbd>D</kbd> mover ¬∑
        <kbd>ESPACIO</kbd> lanzar/pelea ¬∑
        <kbd>ENTER</kbd> empezar ¬∑
        <kbd>R</kbd> reiniciar
      </p>
      <p>
        Celular: usa los botones de abajo (‚óÄÔ∏é ‚ñ∂Ô∏é üé£ üîÅ) ¬∑
        Tienda: haz clic en los botones de la izquierda cuando tengas monedas.
      </p>
      <p>
        Si entras al top 5, escribe tus <strong>iniciales</strong> (3 letras) como en los arcades üéÆ
      </p>
    </div>
  </div>

  <script>
  const cnv = document.getElementById('game');
  const ctx = cnv.getContext('2d');
  const timeEl = document.getElementById('time');
  const livesEl = document.getElementById('lives');
  const scoreEl = document.getElementById('score');
  const coinsEl = document.getElementById('coins');
  const fightWrap = document.getElementById('fightBox');
  const fightBar = document.getElementById('fight');
  const highscoreListEl = document.getElementById('highscore-list');

  const btnReel = document.getElementById('btnReel');
  const btnLine = document.getElementById('btnLine');
  const btnRare = document.getElementById('btnRare');

  const touchControls = document.getElementById('touch-controls');
  const btnLeft = document.getElementById('btnLeft');
  const btnRight = document.getElementById('btnRight');
  const btnCast = document.getElementById('btnCast');
  const btnRestart = document.getElementById('btnRestart');

  const nameTouch = document.getElementById('name-touch');
  const nameLettersEls = [
    document.getElementById('lt0'),
    document.getElementById('lt1'),
    document.getElementById('lt2')
  ];
  const nameOkBtn = document.getElementById('name-ok');

  const W = cnv.width, H = cnv.height;
  const surfaceY = 160; // l√≠nea de agua

  // Detectar touch (para saber si usamos overlay de iniciales)
  const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

  // Estado del juego
  let boatX, boatSpeed;
  let hookX, hookY, lineLenMax;
  let casting, retrieving;
  let hookedFish, inFight, fightValue;
  let score, lives, timeLeft, gameOver;
  let timerId = null;
  let gameStarted = false;

  // Metajuego: top 5
  let highscores = [];
  let coins = 0;

  // Nombre de r√©cord
  let enteringName = false;
  let initials = '';
  let pendingScore = 0;

  // Iniciales para overlay touch
  let touchNameLetters = ['A','A','A'];

  // Mejoras
  let reelPower = 4;
  let lineStrength = 0;
  let rareChance = 0;

  // Peces
  const fishes = [];
  const fishColorsNormal = ['#89c2d9','#61a5c2','#468faf','#2c7da0'];
  const fishColorsSlim   = ['#38bdf8','#0ea5e9'];
  const fishColorsRound  = ['#0f766e','#14b8a6'];
  const fishColorsJelly  = ['#a855f7','#6366f1'];

  // Cielo
  const clouds = [];
  function spawnCloud() {
    const y = 40 + Math.random() * 60;
    const speed = 0.2 + Math.random() * 0.4;
    const width = 80 + Math.random() * 80;
    clouds.push({
      x: Math.random() * W,
      y,
      w: width,
      h: 24 + Math.random() * 8,
      speed
    });
  }

  // Helpers colores d√≠a/noche
  function lerp(a,b,t){ return a + (b-a)*t; }
  function hexToRgb(h){
    const n = parseInt(h.slice(1),16);
    return {r:(n>>16)&255,g:(n>>8)&255,b:n&255};
  }
  function lerpColor(c1,c2,t){
    const a = hexToRgb(c1), b = hexToRgb(c2);
    const r = Math.round(lerp(a.r,b.r,t));
    const g = Math.round(lerp(a.g,b.g,t));
    const b2 = Math.round(lerp(a.b,b.b,t));
    return `rgb(${r},${g},${b2})`;
  }

  // ---------- Audio 8-bit ----------
  let audioCtx = null;
  function initAudio() {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
  }

  function playBeep(freq = 440, duration = 0.08, type = 'square', volume = 0.08) {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.value = freq;
    gain.gain.value = volume;
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    const now = audioCtx.currentTime;
    osc.start(now);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);
    osc.stop(now + duration + 0.02);
  }

  function s_cast()       { playBeep(880, 0.08, 'square'); }
  function s_hook()       { playBeep(660, 0.08, 'square'); }
  function s_catchSmall() { playBeep(900, 0.08, 'square'); playBeep(1200, 0.1, 'triangle', 0.06); }
  function s_catchMed()   { playBeep(700, 0.08, 'square'); playBeep(1050, 0.1, 'square'); playBeep(1350, 0.12, 'triangle', 0.06); }
  function s_catchBig()   { playBeep(500, 0.1, 'square'); playBeep(800, 0.12, 'square'); playBeep(1400, 0.14, 'triangle', 0.07); }
  function s_breakLine()  { playBeep(260, 0.12, 'sawtooth'); }
  function s_gameOver()   { playBeep(220, 0.25, 'square', 0.07); }
  function s_buy()        { playBeep(780, 0.06, 'triangle', 0.06); }

  // ---------- Highscores (backend) ----------
  async function renderHighscores() {
    highscoreListEl.innerHTML = '';
    for (let i = 0; i < 5; i++) {
      const li = document.createElement('li');
      if (i < highscores.length) {
        const h = highscores[i];
        const name = (h.name || '---').padEnd(3, ' ').slice(0,3);
        li.textContent = `${name} ‚Äî ${h.score}`;
      } else {
        li.textContent = '--- ‚Äî 0';
      }
      highscoreListEl.appendChild(li);
    }
  }

  async function loadHighscores() {
    try {
      const res = await fetch('/api/scores');
      if (!res.ok) throw new Error('error scores');
      const data = await res.json();
      highscores = (Array.isArray(data) ? data : [])
        .filter(x => typeof x.score === 'number' && typeof x.name === 'string')
        .sort((a,b) => b.score - a.score)
        .slice(0,5);
    } catch (e) {
      console.error(e);
      highscores = [];
    }
    renderHighscores();
  }

  function qualifiesForTop5(curScore) {
    if (curScore <= 0) return false;
    if (highscores.length < 5) return true;
    const last = highscores[highscores.length - 1];
    return curScore > last.score;
  }

  async function insertHighscore(name, curScore) {
    try {
      await fetch('/api/scores', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ name, score: curScore })
      });
      await loadHighscores();
    } catch (e) {
      console.error(e);
    }
  }

  // ---------- Tienda ----------
  function updateShopUI() {
    btnReel.disabled = coins < 20;
    btnLine.disabled = coins < 30;
    btnRare.disabled = coins < 40;
  }

  function buyUpgrade(type) {
    if (gameOver || enteringName) return;
    if (inFight) return;

    let purchased = false;

    if (type === 'reel' && coins >= 20) {
      coins -= 20;
      reelPower += 1;
      purchased = true;
    } else if (type === 'line' && coins >= 30) {
      coins -= 30;
      lineStrength = Math.min(90, lineStrength + 10);
      purchased = true;
    } else if (type === 'rare' && coins >= 40) {
      coins -= 40;
      rareChance = Math.min(0.5, rareChance + 0.1);
      purchased = true;
    }

    if (purchased) {
      coinsEl.textContent = coins;
      updateShopUI();
      s_buy();
    }
  }

  btnReel.addEventListener('click', () => { initAudio(); buyUpgrade('reel'); });
  btnLine.addEventListener('click', () => { initAudio(); buyUpgrade('line'); });
  btnRare.addEventListener('click', () => { initAudio(); buyUpgrade('rare'); });

  // ---------- Tipos de peces ----------
  function randomFishType() {
    const r = Math.random();
    const goldenBoost = rareChance;
    if (r < 0.04 + goldenBoost) return 'golden';
    if (r < 0.12) return 'jelly';
    if (r < 0.35) return 'slim';
    if (r < 0.65) return 'round';
    return 'normal';
  }

  function typeMultiplier(type) {
    switch(type){
      case 'golden': return 3;
      case 'round':  return 2;
      case 'jelly':  return 2;
      case 'slim':   return 1.5;
      default:       return 1;
    }
  }

  function spawnFish() {
    let type = randomFishType();
    let size, difficulty, speed, color;
    const dir = Math.random() < 0.5 ? -1 : 1;
    const x = dir === 1 ? -40 : W + 40;
    const yBase = surfaceY + 40 + Math.random() * (H - surfaceY - 90);

    if (type === 'slim') {
      size = 18;
      difficulty = 45;
      speed = 2.3 * (0.8 + Math.random()*0.6);
      color = fishColorsSlim[Math.floor(Math.random()*fishColorsSlim.length)];
    } else if (type === 'round') {
      size = 26;
      difficulty = 60;
      speed = 1.6 * (0.8 + Math.random()*0.6);
      color = fishColorsRound[Math.floor(Math.random()*fishColorsRound.length)];
    } else if (type === 'golden') {
      size = 24;
      difficulty = 65;
      speed = 1.6 * (0.8 + Math.random()*0.6);
      color = '#facc15';
    } else if (type === 'jelly') {
      size = 22;
      difficulty = 55;
      speed = 1.1 * (0.8 + Math.random()*0.6);
      color = fishColorsJelly[Math.floor(Math.random()*fishColorsJelly.length)];
    } else {
      if (Math.random() < rareChance) {
        size = 34;
      } else {
        size = Math.random() < 0.5 ? 16 : Math.random() < 0.8 ? 24 : 34;
      }
      difficulty = size === 16 ? 35 : size === 24 ? 55 : 75;
      speed = (size === 34 ? 1.2 : size === 24 ? 1.6 : 2.1) * (0.8 + Math.random()*0.6);
      color = fishColorsNormal[Math.floor(Math.random()*fishColorsNormal.length)];
    }

    const y = yBase;
    fishes.push({x,y,dir,speed,size,color,difficulty,type});
  }

  function resetGameState(){
    fishes.length = 0;
    for (let i=0;i<10;i++) spawnFish();

    clouds.length = 0;
    for (let i=0;i<5;i++) spawnCloud();

    boatX = W/2; boatSpeed = 4;
    hookX = boatX; hookY = surfaceY + 18;
    lineLenMax = H - 40;
    casting = false;
    retrieving = false;
    hookedFish = null;
    inFight = false;
    fightValue = 0;
    score = 0; lives = 3; timeLeft = 360; gameOver = false;
    coins = 0;
    gameStarted = false;
    enteringName = false;
    initials = '';
    pendingScore = 0;

    timeEl.textContent = timeLeft;
    livesEl.textContent = lives;
    scoreEl.textContent = score;
    coinsEl.textContent = coins;
    fightWrap.style.display = 'none';
    fightBar.value = 0;
    updateShopUI();
  }

  function startTimer(){
    if (timerId) clearInterval(timerId);
    timerId = setInterval(()=>{
      if (!gameStarted || gameOver) return;
      timeLeft--; timeEl.textContent = timeLeft;
      if (timeLeft <= 0) endGame();
    }, 1000);
  }

  function endGame(){
    gameOver = true;
    if (timerId) { clearInterval(timerId); timerId = null; }

    s_gameOver();

    if (qualifiesForTop5(score)) {
      enteringName = true;
      initials = '';
      pendingScore = score;

      // En m√≥vil: mostrar overlay de iniciales con flechas
      if (isTouch && nameTouch) {
        touchNameLetters = ['A','A','A'];
        renderTouchName();
        nameTouch.style.display = 'flex';
      }
    }
  }

  // Input teclado
  const keys = new Set();

  addEventListener('keydown', (e)=>{
    const k = e.key;
    if (['ArrowUp','ArrowDown',' '].includes(k)) e.preventDefault();

    if (!audioCtx && (k === ' ' || k === 'Enter')) {
      initAudio();
    }

    if (enteringName) {
      // En desktop seguimos usando teclado para iniciales
      handleInitialsInput(e);
      return;
    }

    if (k === ' '){
      if (e.repeat) return;
      if (!gameStarted && !gameOver) {
        gameStarted = true;
        startTimer();
        s_cast();
        return;
      }
      handleSpace();
      return;
    }

    if (k === 'Enter' && !gameStarted && !gameOver){
      gameStarted = true;
      startTimer();
      s_cast();
      return;
    }

    if (k.toLowerCase() === 'r' && gameOver && !enteringName){
      resetGameState();
      startTimer();
      return;
    }

    keys.add(k.toLowerCase());
  });

  addEventListener('keyup', (e)=>{ keys.delete(e.key.toLowerCase()); });

  function handleInitialsInput(e){
    const k = e.key;
    const isLetter = /^[a-zA-Z]$/.test(k);

    if (isLetter && initials.length < 3){
      initials += k.toUpperCase();
      return;
    }

    if (k === 'Backspace'){
      initials = initials.slice(0, -1);
      return;
    }

    if (k === 'Enter' && initials.length > 0){
      insertHighscore(initials, pendingScore);
      enteringName = false;
      return;
    }
  }

  function handleSpace(){
    if (gameOver) return;

    if (!casting && !retrieving && !inFight && !hookedFish) {
      hookX = boatX; casting = true;
      s_cast();
      return;
    }

    if (inFight && hookedFish) {
      fightValue = Math.min(100, fightValue + 10);
      fightBar.value = fightValue;
      hookY = Math.max(surfaceY + 18, hookY - reelPower);

      if (hookY <= surfaceY + 22) {
        captureFish();
        return;
      }
      return;
    }

    if (!inFight && !hookedFish && (casting || retrieving)) {
      retrieving = true; casting = false;
    }
  }

  function captureFish(){
    if (!hookedFish) return;
    const size = hookedFish.size;
    let baseScore = 1;
    let baseCoins = 1;

    if (size >= 34) { baseScore = 3; baseCoins = 5; }
    else if (size >= 24) { baseScore = 2; baseCoins = 3; }

    const mult = typeMultiplier(hookedFish.type || 'normal');
    const gainedScore = Math.round(baseScore * mult);
    const gainedCoins = Math.round(baseCoins * mult);

    score += gainedScore;
    coins += gainedCoins;

    scoreEl.textContent = score;
    coinsEl.textContent = coins;
    updateShopUI();

    const idx = fishes.indexOf(hookedFish); if (idx>=0) fishes.splice(idx,1);
    spawnFish();

    if (size >= 34) s_catchBig();
    else if (size >= 24) s_catchMed();
    else s_catchSmall();

    inFight = false;
    hookedFish = null;
    fightWrap.style.display = 'none';
    retrieving = true;
  }

  function update() {
    if (!gameStarted || gameOver) {
      for (const c of clouds) {
        c.x += c.speed;
        if (c.x - c.w > W + 40) {
          c.x = -c.w - 40;
          c.y = 40 + Math.random() * 60;
          c.speed = 0.2 + Math.random() * 0.4;
        }
      }
      return;
    }

    if (!casting && !retrieving && !inFight) {
      if (keys.has('a')) boatX -= boatSpeed;
      if (keys.has('d')) boatX += boatSpeed;
      boatX = Math.max(60, Math.min(W-60, boatX));
      hookX = boatX;
      hookY = surfaceY + 18;
    }

    if (casting && !inFight) {
      hookY += 4.2;
      if (hookY > lineLenMax) { casting = false; retrieving = true; }
    }
    if (retrieving && !inFight) {
      hookY -= 5.0;
      if (hookY <= surfaceY + 18) { retrieving = false; }
    }

    for (const f of fishes) {
      if (f === hookedFish && inFight) continue;
      f.x += f.speed * f.dir;
      if (f.dir === 1 && f.x > W+50) { f.dir = -1; f.y = surfaceY + 40 + Math.random()*(H-surfaceY-90); }
      if (f.dir === -1 && f.x < -50) { f.dir = 1; f.y = surfaceY + 40 + Math.random()*(H-surfaceY-90); }
    }

    if (!inFight && casting && !hookedFish) {
      for (const f of fishes) {
        if (Math.abs(f.x - hookX) < f.size && Math.abs(f.y - hookY) < f.size) {
          hookedFish = f; inFight = true; casting = false; retrieving = false;
          fightValue = 35;
          fightBar.value = fightValue; fightWrap.style.display = 'inline-flex';
          s_hook();
          break;
        }
      }
    }

    if (inFight && hookedFish) {
      const pull = hookedFish.difficulty * 0.04;
      const resistFactor = 1 - (lineStrength / 100);
      fightValue = Math.max(0, fightValue - pull * 0.2 * resistFactor);
      fightBar.value = fightValue;

      const wiggle = Math.sin(Date.now()*0.02) * 4;
      hookedFish.x = hookX + wiggle;
      hookedFish.y = hookY + 20;

      if (fightValue < 40 && hookY < lineLenMax) {
        hookY += 0.3;
      }

      if (fightValue <= 0) {
        lives--; livesEl.textContent = lives;
        inFight = false;
        fightWrap.style.display = 'none';
        if (lives <= 0) endGame();
        hookedFish = null;
        retrieving = true;
        s_breakLine();
      }
    }

    for (const c of clouds) {
      c.x += c.speed;
      if (c.x - c.w > W + 40) {
        c.x = -c.w - 40;
        c.y = 40 + Math.random() * 60;
        c.speed = 0.2 + Math.random() * 0.4;
      }
    }
  }

  function drawSky(){
    const t = Date.now() * 0.00003;
    const phase = (Math.sin(t) + 1) / 2;

    const topNight = '#020617';
    const midNight = '#0f172a';
    const botNight = '#1d4ed8';

    const topDay = '#0f172a';
    const midDay = '#1d4ed8';
    const botDay = '#38bdf8';

    const top = lerpColor(topNight, topDay, phase);
    const mid = lerpColor(midNight, midDay, phase);
    const bot = lerpColor(botNight, botDay, phase);

    const skyGrad = ctx.createLinearGradient(0,0,0,surfaceY);
    skyGrad.addColorStop(0, top);
    skyGrad.addColorStop(0.5, mid);
    skyGrad.addColorStop(1, bot);
    ctx.fillStyle = skyGrad;
    ctx.fillRect(0,0,W,surfaceY);

    const sunX = W * 0.15 + Math.sin(t*1.2) * 40;
    const sunY = surfaceY * (0.2 + 0.2 * Math.cos(t*1.1));
    const sunGrad = ctx.createRadialGradient(sunX, sunY, 0, sunX, sunY, 40);
    const sunColor = phase > 0.5 ? '#fde68a' : '#bfdbfe';
    sunGrad.addColorStop(0, sunColor);
    sunGrad.addColorStop(1, 'rgba(252,211,77,0)');
    ctx.fillStyle = sunGrad;
    ctx.beginPath();
    ctx.arc(sunX, sunY, 40, 0, Math.PI*2);
    ctx.fill();

    ctx.fillStyle = 'rgba(241,245,249,' + (0.5 + 0.4*phase) + ')';
    for (const c of clouds) {
      ctx.beginPath();
      ctx.ellipse(c.x, c.y, c.w * 0.5, c.h * 0.5, 0, 0, Math.PI*2);
      ctx.fill();
    }
  }

  function drawWater(){
    const waterGrad = ctx.createLinearGradient(0,surfaceY,0,H);
    waterGrad.addColorStop(0, '#0ea5e9');
    waterGrad.addColorStop(0.4, '#0369a1');
    waterGrad.addColorStop(1, '#020617');
    ctx.fillStyle = waterGrad;
    ctx.fillRect(0,surfaceY,W,H-surfaceY);

    ctx.fillStyle = 'rgba(255,255,255,0.14)';
    for (let x=0; x<W; x+=24) {
      ctx.beginPath();
      const y = surfaceY + Math.sin((x+Date.now()*0.002)*0.06)*2;
      ctx.ellipse(x+12, y, 18, 6, 0, 0, Math.PI*2);
      ctx.fill();
    }
  }

  function drawBoat(){
    ctx.save();
    ctx.translate(boatX, surfaceY-6);
    ctx.fillStyle = '#f97316';
    ctx.beginPath();
    ctx.moveTo(-40,0); ctx.lineTo(40,0); ctx.lineTo(22,14); ctx.lineTo(-22,14); ctx.closePath(); ctx.fill();
    ctx.fillStyle = '#ffe4b5';
    ctx.fillRect(-3,-18,6,18);
    ctx.restore();
  }

  function drawLineAndHook(){
    ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 2; ctx.beginPath();
    ctx.moveTo(boatX, surfaceY-6); ctx.lineTo(hookX, hookY-8); ctx.stroke();
    ctx.save();
    ctx.translate(hookX, hookY);
    ctx.strokeStyle = '#facc15'; ctx.lineWidth = 3; ctx.beginPath();
    ctx.moveTo(0,-8); ctx.lineTo(0,6); ctx.arc(6,6,6,Math.PI,Math.PI*1.75);
    ctx.stroke();
    ctx.restore();
  }

  function drawFishes(){
    for (const f of fishes) {
      if (f.type === 'jelly') {
        ctx.save();
        ctx.translate(f.x, f.y);
        ctx.fillStyle = f.color;
        ctx.beginPath();
        ctx.ellipse(0,0,f.size, f.size*0.7, 0, Math.PI, 0, true);
        ctx.fill();
        ctx.beginPath();
        ctx.moveTo(-f.size*0.6,0);
        ctx.lineTo(-f.size*0.4,f.size*0.9);
        ctx.moveTo(-f.size*0.2,0);
        ctx.lineTo(-f.size*0.1,f.size);
        ctx.moveTo(0,0);
        ctx.lineTo(0.1*f.size,f.size*0.9);
        ctx.moveTo(f.size*0.2,0);
        ctx.lineTo(f.size*0.3,f.size*0.9);
        ctx.strokeStyle = f.color;
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.restore();
        continue;
      }

      ctx.save();
      ctx.translate(f.x, f.y);
      ctx.scale(f.dir,1);

      let bodyW = f.size;
      let bodyH = f.size*0.6;

      if (f.type === 'slim') {
        bodyW = f.size + 6;
        bodyH = f.size*0.4;
      } else if (f.type === 'round') {
        bodyH = f.size*0.9;
      } else if (f.type === 'golden') {
        bodyH = f.size*0.7;
      }

      ctx.fillStyle = f.color;
      ctx.beginPath();
      ctx.ellipse(0,0,bodyW, bodyH, 0, 0, Math.PI*2);
      ctx.fill();

      if (f.type === 'golden' || f.type === 'round') {
        ctx.fillStyle = 'rgba(253,224,71,0.4)';
        ctx.beginPath();
        ctx.ellipse(-bodyW*0.1,-bodyH*0.3,bodyW*0.4, bodyH*0.3, 0,0,Math.PI*2);
        ctx.fill();
      }

      ctx.beginPath();
      ctx.moveTo(-bodyW,0);
      ctx.lineTo(-bodyW-8,6);
      ctx.lineTo(-bodyW-8,-6);
      ctx.closePath();
      ctx.fill();

      ctx.fillStyle = '#020617';
      ctx.beginPath();
      ctx.arc(bodyW*0.4,-2,2.5,0,Math.PI*2);
      ctx.fill();

      ctx.restore();
    }
  }

  function drawStartScreen(){
    if (gameStarted || gameOver) return;
    ctx.fillStyle = 'rgba(15,23,42,0.65)';
    ctx.fillRect(0,0,W,H);
    ctx.textAlign = 'center';

    ctx.fillStyle = '#facc15';
    ctx.font = 'bold 46px system-ui';
    ctx.fillText('PESCA RETRO', W/2, H/2 - 40);

    ctx.fillStyle = '#e5e7eb';
    ctx.font = '18px system-ui';
    ctx.fillText('Pulsa ESPACIO, ENTER o üé£ para empezar', W/2, H/2 + 8);
    ctx.font = '14px system-ui';
    ctx.fillText('Atrapa peces, mejora tu equipo y entra al top 5.', W/2, H/2 + 40);
  }

  function drawNameEntry(){
    if (!enteringName) return;
    ctx.fillStyle = 'rgba(15,23,42,0.9)';
    ctx.fillRect(0,0,W,H);

    ctx.textAlign = 'center';
    ctx.fillStyle = '#facc15';
    ctx.font = 'bold 40px system-ui';
    ctx.fillText('¬°NUEVO TOP 5!', W/2, H/2 - 60);

    ctx.fillStyle = '#e5e7eb';
    ctx.font = '18px system-ui';
    ctx.fillText(`Puntos: ${pendingScore}`, W/2, H/2 - 20);
    ctx.fillText('Escribe tus iniciales (A-Z), ENTER para guardar', W/2, H/2 + 10);

    let shown;
    if (isTouch && nameTouch && nameTouch.style.display !== 'none') {
      shown = touchNameLetters.join('');
    } else {
      shown = (initials + '___').slice(0,3);
    }
    ctx.font = 'bold 32px system-ui';
    ctx.fillText(shown.split('').join(' '), W/2, H/2 + 60);
  }

  function drawGameOver(){
    if (!gameOver || enteringName) return;
    ctx.fillStyle = 'rgba(15,23,42,.8)'; ctx.fillRect(0,0,W,H);
    ctx.fillStyle = '#e5e7eb'; ctx.textAlign = 'center';
    ctx.font = 'bold 42px system-ui'; ctx.fillText('Juego terminado', W/2, H/2-20);

    const top = highscores[0];
    const bestText = top ? `${top.name} ${top.score}` : '--- 0';

    ctx.font = 'bold 20px system-ui';
    ctx.fillText(`Puntos: ${score}  ¬∑  Mejor: ${bestText}`, W/2, H/2+18);
    ctx.font = '16px system-ui';
    ctx.fillText('Pulsa R o üîÅ para reiniciar', W/2, H/2+48);
  }

  function drawFightHint(){
    if (inFight && hookedFish && !gameOver && !enteringName) {
      ctx.fillStyle = 'rgba(15,23,42,.20)';
      ctx.fillRect(0,0,W,90);
      ctx.fillStyle = '#e5e7eb'; ctx.font = '18px system-ui'; ctx.textAlign = 'center';
      ctx.fillText('¬°Pulsa ESPACIO o üé£ repetidamente para ganar la pelea!', W/2, 55);
    }
  }

  function drawUI(){
    drawStartScreen();
    drawNameEntry();
    drawGameOver();
    drawFightHint();
  }

  function loop(){
    update();
    ctx.clearRect(0,0,W,H);
    drawSky();
    drawWater();
    drawFishes();
    drawBoat();
    drawLineAndHook();
    drawUI();
    requestAnimationFrame(loop);
  }

  // --------- Controles touch ----------
  function addHoldButton(btn, key){
    const down = (e) => {
      e.preventDefault();
      keys.add(key);
    };
    const up = (e) => {
      e.preventDefault();
      keys.delete(key);
    };
    btn.addEventListener('touchstart', down);
    btn.addEventListener('touchend', up);
    btn.addEventListener('touchcancel', up);
    btn.addEventListener('mousedown', down);
    btn.addEventListener('mouseup', up);
    btn.addEventListener('mouseleave', up);
  }

  if (isTouch && touchControls) {
    touchControls.style.display = 'flex';
  }

  if (btnLeft && btnRight) {
    addHoldButton(btnLeft, 'a');
    addHoldButton(btnRight, 'd');
  }

  if (btnCast) {
    const tapCast = (e) => {
      e.preventDefault();
      if (!audioCtx) initAudio();
      if (!gameStarted && !gameOver) {
        gameStarted = true;
        startTimer();
        s_cast();
        return;
      }
      handleSpace();
    };
    btnCast.addEventListener('click', tapCast);
    btnCast.addEventListener('touchstart', tapCast);
  }

  if (btnRestart) {
    const tapRestart = (e) => {
      e.preventDefault();
      if (gameOver && !enteringName) {
        resetGameState();
        startTimer();
      }
    };
    btnRestart.addEventListener('click', tapRestart);
    btnRestart.addEventListener('touchstart', tapRestart);
  }

  // --------- Overlay de iniciales touch ----------
  function renderTouchName() {
    for (let i = 0; i < 3; i++) {
      nameLettersEls[i].textContent = touchNameLetters[i];
    }
  }

  if (nameTouch) {
    document.querySelectorAll('#name-touch button[data-slot]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const slot = parseInt(btn.dataset.slot, 10);
        const dir = btn.dataset.dir;
        let code = touchNameLetters[slot].charCodeAt(0);
        if (dir === 'up') code++;
        else code--;
        if (code > 90) code = 65;  // Z -> A
        if (code < 65) code = 90;  // A -> Z
        touchNameLetters[slot] = String.fromCharCode(code);
        renderTouchName();
      });
    });

    if (nameOkBtn) {
      nameOkBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const name = touchNameLetters.join('');
        insertHighscore(name, pendingScore);
        enteringName = false;
        nameTouch.style.display = 'none';
      });
    }
  }

  // Arranque inicial
  loadHighscores();
  resetGameState();
  startTimer();
  requestAnimationFrame(loop);
  </script>
</body>
</html>
